@page "{id:int}"
@model DetailModel
@{
    ViewData["Title"] = "Chi ti·∫øt c√¢y tr·ªìng";
}
<link rel="stylesheet" href="~/css/PlantDetail.css?v1.1" />

<div class="container plant-detail mt-4">
    <h2>@Model.Plant?.PlantName</h2>
    <div class="row">
        <div class="col-md-6">
            @foreach (var img in Model.ImageUrls)
            {
                <img src="@img" class="img-fluid mb-2" alt="@Model.Plant.PlantName" />
            }
        </div>
        <div class="col-md-6">
            <p><strong>T√™n khoa h·ªçc:</strong> @Model.Plant?.ScienceName</p>
            <p><strong>Xu·∫•t x·ª©:</strong> @Model.Plant?.Origin</p>
            <p><strong>Th·ªùi gian sinh tr∆∞·ªüng:</strong> @Model.Plant?.GrowthDuration ng√†y</p>
            <p><strong>M√¥ t·∫£:</strong> @Model.Plant?.Description</p>
            <p><strong>Lo·∫°i c√¢y:</strong> @string.Join(", ", Model.Plant?
                                .Types.Select(t => t.TypeName) ??
                                Enumerable.Empty<string>())</p>
            <p><strong>M√πa tr·ªìng:</strong> @string.Join(", ", Model.Plant?.Seasons.Select(s => s.SeasonName) ??
                                Enumerable.Empty<string>())</p>
            <p><strong>V√πng ph√π h·ª£p:</strong> @string.Join(", ", Model.Plant?.Regions.Select(r => r.RegionName) ??
                                Enumerable.Empty<string>())</p>
            <p><strong>Lo·∫°i ƒë·∫•t:</strong> @string.Join(", ", Model.Soils.Select(s => s.SoilName))</p>
            <p><strong>Ph√¢n b√≥n:</strong> @string.Join(", ", Model.Fertilizers.Select(f => f.TypeName))</p>

            <button class="btn btn-outline-danger mt-3" data-bs-toggle="modal" data-bs-target="#diseaseModal">B·ªánh c√¢y
                tr·ªìng</button>
            <button class="btn btn-outline-primary mt-3 ms-2" data-bs-toggle="modal" data-bs-target="#careModal">ChƒÉm
                s√≥c c√¢y tr·ªìng</button>
        </div>
    </div>
</div>

<!-- Modal: B·ªánh c√¢y tr·ªìng -->
<div class="modal fade" id="diseaseModal" tabindex="-1" aria-labelledby="diseaseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">B·ªánh c√¢y tr·ªìng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                @if (Model.DiseaseTreatments.Any())
                {
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>B·ªánh</th>
                                <th>Tri·ªáu ch·ª©ng</th>
                                <th>Nguy√™n nh√¢n</th>
                                <th>ƒêi·ªÅu tr·ªã</th>
                                <th>Ghi ch√∫</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var dt in Model.DiseaseTreatments)
                            {
                                <tr>
                                    <td>@dt.Disease?.DiseaseName</td>
                                    <td>@dt.Disease?.Symptoms</td>
                                    <td>@dt.Disease?.Causes</td>
                                    <td>@dt.TreatmentMethod</td>
                                    <td>@dt.Notes</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p>Kh√¥ng c√≥ th√¥ng tin b·ªánh ho·∫∑c c√°ch ƒëi·ªÅu tr·ªã cho c√¢y n√†y.</p>
                }

            </div>
        </div>
    </div>
</div>

<!-- Modal: ChƒÉm s√≥c c√¢y tr·ªìng -->
<div class="modal fade" id="careModal" tabindex="-1" aria-labelledby="careModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ph∆∞∆°ng ph√°p chƒÉm s√≥c</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                @if (Model.CultivationMethods.Any())
                {
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Ph∆∞∆°ng ph√°p</th>
                                <th>M√¥ t·∫£</th>
                                <th>Ghi ch√∫</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (Models.CultivationMethod method in Model.CultivationMethods)
                            {
                                <tr>
                                    <td>@method.MethodName</td>
                                    <td>@method.Description</td>
                                    <td>@method.Notes</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p>Ch∆∞a c√≥ th√¥ng tin chƒÉm s√≥c cho c√¢y n√†y.</p>
                }
            </div>
        </div>
    </div>
</div>
<hr />

<!-- ‚≠ê Ph·∫ßn ƒë√°nh gi√° -->
<div class="mt-5">
    <h4 class="fw-bold text-warning mb-3">
        <i class="bi bi-star-fill"></i> ƒê√°nh gi√° c√¢y tr·ªìng
    </h4>

    @if (Model.RatingCount > 0)
    {
        <div class="d-flex align-items-center mb-3">
            <div class="me-3">
                @{
                    double avg = Model.AverageRating;
                }
                @for (int i = 1; i <= 5; i++)
                {
                    if (i <= Math.Floor(avg))
                    {
                        // Sao ƒë·∫ßy
                        <i class="bi bi-star-fill text-warning fs-4"></i>
                    }
                    else if (i - avg <= 0.5 && i > avg)
                    {
                        // Sao n·ª≠a
                        <i class="bi bi-star-half text-warning fs-4"></i>
                    }
                    else
                    {
                        // Sao r·ªóng
                        <i class="bi bi-star text-secondary fs-4"></i>
                    }
                }

            </div>
            <div>
                <strong class="fs-5">@Model.AverageRating.ToString("0.0")</strong> / 5
                <span class="text-muted">(@Model.RatingCount l∆∞·ª£t ƒë√°nh gi√°)</span>
            </div>
        </div>
    }
    else
    {
        <p class="text-muted fst-italic">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o cho c√¢y n√†y.</p>
    }
</div>

<hr class="my-4" />

<!-- üí¨ Ph·∫ßn b√¨nh lu·∫≠n -->
<div class="mt-4">
    <h4 class="fw-bold text-success mb-3">
        <i class="bi bi-chat-dots-fill"></i> B√¨nh lu·∫≠n
    </h4>

    @if (Model.Comments.Any())
    {
        <div class="list-group shadow-sm rounded-3">
            @foreach (var c in Model.Comments)
            {
                <div class="list-group-item border-0 border-bottom py-3">
                    <div class="d-flex align-items-start">
                        <!-- Avatar (ng·∫´u nhi√™n) -->
                        <div class="me-3">
                            <img src="https://ui-avatars.com/api/?name=@(c.Account?.Username ?? "User")&background=random&size=48"
                                class="rounded-circle shadow-sm" alt="avatar">
                        </div>

                        <!-- N·ªôi dung -->
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between">
                                <strong>@(c.Account?.Username ?? "Ng∆∞·ªùi d√πng ·∫©n danh")</strong>
                                <small class="text-muted">@c.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small>
                            </div>
                            <p class="mt-2 mb-0">@c.Content</p>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <p class="text-muted fst-italic">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o cho c√¢y n√†y.</p>
    }
</div>
<!-- Form th√™m b√¨nh lu·∫≠n -->
<div class="mt-4">
    <h5 class="fw-bold text-primary mb-3">ƒêƒÉng b√¨nh lu·∫≠n</h5>

    @if (User.Identity?.IsAuthenticated ?? false)
    {
        <form method="post">
            <div class="mb-3">
                <textarea class="form-control" name="Content" rows="3" placeholder="Vi·∫øt b√¨nh lu·∫≠n c·ªßa b·∫°n..."
                          required></textarea>
            </div>
            <input type="hidden" name="PlantId" value="@Model.Plant?.Id" />
            <button type="submit" class="btn btn-success">G·ª≠i b√¨nh lu·∫≠n</button>
        </form>
    }
    else
    {
        <p class="text-muted">B·∫°n c·∫ßn <a href="/Identity/Account/Login">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ b√¨nh lu·∫≠n.</p>
    }
</div>
    